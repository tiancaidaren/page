<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKX é‡åŒ–äº¤æ˜“ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', '"Helvetica Neue"', 'Arial', 'sans-serif']
                    }
                }
            }
        };
    </script>
</head>
<body class="bg-slate-100 text-slate-800">
<div id="root" class="h-screen"></div>

<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
    const { useState, useRef } = React;

    const navItems = [
        { id: 'dashboard', label: 'ğŸ“Š ä¸»é¡µ' },
        { id: 'executions', label: 'ğŸ“ˆ æ‰§è¡Œè®°å½•' },
        { id: 'accounts', label: 'ğŸ‘¤ è´¦å·ç®¡ç†' },
        { id: 'settings', label: 'âš™ï¸ è®¾ç½®' },
        { id: 'strategy-config', label: 'ğŸ§  ç­–ç•¥é…ç½®' }
    ];

    const indicatorDefinitions = {
        sar: {
            name: 'æŠ›ç‰©çº¿è½¬å‘ (SAR)',
            fields: [
                { name: 'condition', label: 'è§¦å‘æ¡ä»¶', type: 'select', default: 'Kçº¿ä¸Šç©¿', options: ['Kçº¿ä¸Šç©¿', 'Kçº¿ä¸‹ç©¿', 'ä¸Šç©¿æˆ–ä¸‹ç©¿'] },
                { name: 'step', label: 'æ­¥é•¿', type: 'number', default: '0.02', step: '0.01', min: '0', max: '1' },
                { name: 'max', label: 'æœ€å¤§æ­¥é•¿', type: 'number', default: '0.2', step: '0.01', min: '0', max: '1' }
            ]
        },
        'period-high': {
            name: 'å‘¨æœŸæœ€é«˜ç‚¹çªç ´',
            fields: [
                { name: 'comparison', label: 'æ¯”è¾ƒç¬¦å·', type: 'select', default: 'å¤§äº', options: ['å¤§äº', 'å°äº'] },
                { name: 'period', label: 'å‘¨æœŸ (æ ¹ K çº¿)', type: 'number', default: '24', min: '1' }
            ]
        },
        'period-low': {
            name: 'å‘¨æœŸæœ€ä½ç‚¹è·Œç ´',
            fields: [
                { name: 'comparison', label: 'æ¯”è¾ƒç¬¦å·', type: 'select', default: 'å°äº', options: ['å¤§äº', 'å°äº'] },
                { name: 'period', label: 'å‘¨æœŸ (æ ¹ K çº¿)', type: 'number', default: '24', min: '1' }
            ]
        },
        rsi: {
            name: 'RSI ç›¸å¯¹å¼ºå¼±',
            fields: [
                { name: 'period', label: 'å‘¨æœŸ', type: 'number', default: '14', min: '1' },
                { name: 'threshold', label: 'é˜ˆå€¼', type: 'number', default: '70', min: '0', max: '100' },
                { name: 'condition', label: 'æ¡ä»¶', type: 'select', default: 'è¶…ä¹°', options: ['è¶…ä¹°', 'è¶…å–'] }
            ]
        },
        ma: {
            name: 'ç§»åŠ¨å¹³å‡ (MA)',
            fields: [
                { name: 'type', label: 'ç±»å‹', type: 'select', default: 'SMA', options: ['SMA', 'EMA'] },
                { name: 'condition', label: 'æ¡ä»¶', type: 'select', default: 'ä»·æ ¼ä¸Šç©¿', options: ['ä»·æ ¼ä¸Šç©¿', 'ä»·æ ¼ä¸‹ç©¿', 'é‡‘å‰', 'æ­»å‰'] },
                { name: 'fast', label: 'å¿«çº¿å‘¨æœŸ', type: 'number', default: '5', min: '1' },
                { name: 'slow', label: 'æ…¢çº¿å‘¨æœŸ', type: 'number', default: '20', min: '1' }
            ]
        },
        bollinger: {
            name: 'å¸ƒæ—å¸¦',
            fields: [
                { name: 'condition', label: 'æ¡ä»¶', type: 'select', default: 'çªç ´ä¸Šè½¨', options: ['çªç ´ä¸Šè½¨', 'è·Œç ´ä¸‹è½¨', 'å›è½ä¸­è½¨'] },
                { name: 'period', label: 'å‘¨æœŸ', type: 'number', default: '20', min: '1' },
                { name: 'std', label: 'æ ‡å‡†å·®å€æ•°', type: 'number', default: '2', step: '0.1', min: '0' }
            ]
        },
        kdj: {
            name: 'KDJ æŒ‡æ ‡',
            fields: [
                { name: 'condition', label: 'æ¡ä»¶', type: 'select', default: 'é‡‘å‰', options: ['é‡‘å‰', 'æ­»å‰', 'K å€¼ä¸Šç©¿', 'K å€¼ä¸‹ç©¿'] },
                { name: 'value', label: 'é˜ˆå€¼', type: 'number', default: '80', min: '0', max: '100' },
                { name: 'period', label: 'å‘¨æœŸ', type: 'number', default: '9', min: '1' }
            ]
        }
    };

    const positionConfigs = {
        kelly: [
            { name: 'winRate', label: 'èƒœç‡ (0-1)', type: 'number', default: '0.6', step: '0.01', min: '0', max: '1' },
            { name: 'rewardRisk', label: 'ç›ˆäºæ¯”', type: 'number', default: '2', step: '0.1', min: '0' }
        ],
        'fixed-ratio': [
            { name: 'ratio', label: 'ä»“ä½æ¯”ä¾‹ (%)', type: 'number', default: '10', min: '0', max: '100' }
        ],
        'fixed-amount': [
            { name: 'amount', label: 'å›ºå®šé‡‘é¢ (USDT)', type: 'number', default: '1000', min: '0' }
        ],
        atr: [
            { name: 'multiplier', label: 'ATR å€æ•°', type: 'number', default: '1.5', step: '0.1', min: '0' },
            { name: 'period', label: 'ATR å‘¨æœŸ', type: 'number', default: '14', min: '1' }
        ]
    };

    const defaultStrategies = [
        {
            name: 'BTC-SAR-çªç ´ç­–ç•¥',
            accounts: ['ä¸»è´¦å·', 'å¤‡ç”¨è´¦å·'],
            createdAt: '2025-10-08 14:30',
            status: { attack: 'è¿è¡Œä¸­', defense: 'å·²åœæ­¢' },
            asset: 'BTC',
            directions: { attack: 'long', defense: 'short' }
        },
        {
            name: 'ETH-å‘¨æœŸæå€¼ç­–ç•¥',
            accounts: ['ä¸»è´¦å·'],
            createdAt: '2025-10-07 09:15',
            status: { attack: 'è¿è¡Œä¸­', defense: 'è¿è¡Œä¸­' },
            asset: 'ETH',
            directions: { attack: 'long', defense: 'short' }
        }
    ];

    const defaultAccounts = [
        {
            name: 'ä¸»è´¦å·',
            apiKey: '****-****-****-a1b2',
            status: 'å·²è¿æ¥',
            createdAt: '2025-10-05 10:15',
            tradesToday: 8,
            pnlToday: '+$126.40',
            strategies: ['BTC-SAR-çªç ´ç­–ç•¥', 'ETH-å‘¨æœŸæå€¼ç­–ç•¥']
        },
        {
            name: 'å¤‡ç”¨è´¦å·',
            apiKey: '****-****-****-c3d4',
            status: 'å·²è¿æ¥',
            createdAt: '2025-10-05 14:20',
            tradesToday: 4,
            pnlToday: '+$89.60',
            strategies: ['BTC-SAR-çªç ´ç­–ç•¥']
        }
    ];

    const initialLogs = [
        {
            id: 1,
            timestamp: '2025-10-09 10:23:47',
            account: 'ä¸»è´¦å·',
            strategy: 'BTC-SAR-çªç ´ç­–ç•¥',
            type: 'è¿›æ”»',
            message: 'ğŸ“ˆ ä¿¡å·è§¦å‘: SAR ä¸Šç©¿ + RSI > 70',
            details: []
        },
        {
            id: 2,
            timestamp: '2025-10-09 10:23:49',
            account: 'ä¸»è´¦å·',
            strategy: 'BTC-SAR-çªç ´ç­–ç•¥',
            type: 'è¿›æ”»',
            message: 'âœ… ä¸‹å•æˆåŠŸ',
            details: [
                { label: 'äº¤æ˜“å¯¹', value: 'BTC-USDT' },
                { label: 'æ–¹å‘', value: 'å¼€å¤š', tone: 'long' },
                { label: 'æ•°é‡', value: '0.05 BTC' }
            ]
        },
        {
            id: 3,
            timestamp: '2025-10-09 10:24:12',
            account: 'ä¸»è´¦å·',
            strategy: 'BTC-SAR-çªç ´ç­–ç•¥',
            type: 'è¿›æ”»',
            message: 'ğŸ’° è®¢å•æˆäº¤',
            details: [
                { label: 'æˆäº¤ä»·', value: '$28,450' },
                { label: 'æˆäº¤é¢', value: '$1,422.50' }
            ]
        }
    ];

    const initialExecutions = [
        {
            id: 1,
            time: '10:24:12',
            account: 'ä¸»è´¦å·',
            strategy: 'BTC-SAR-çªç ´ç­–ç•¥',
            type: 'è¿›æ”»',
            symbol: 'BTC-USDT',
            direction: 'long',
            amount: '0.05',
            open: 28450,
            close: 28906,
            pnl: 45.3,
            remark: 'SAR ä¸Šç©¿è§¦å‘'
        },
        {
            id: 2,
            time: '10:18:35',
            account: 'å¤‡ç”¨è´¦å·',
            strategy: 'ETH-å‘¨æœŸæå€¼ç­–ç•¥',
            type: 'é˜²å®ˆ',
            symbol: 'ETH-USDT',
            direction: 'short',
            amount: '2.5',
            open: 1845,
            close: 1840,
            pnl: -12.5,
            remark: 'æ­¢æŸé€€å‡º'
        }
    ];

    let globalSignalSeed = 0;

    const directionTexts = {
        long: 'å¼€å¤š',
        short: 'å¼€ç©º',
        auto: 'è‡ªåŠ¨'
    };

    const directionTone = dir => (dir === 'long' ? 'text-emerald-600' : 'text-rose-500');

    const statusTone = status => status === 'è¿è¡Œä¸­'
        ? 'bg-emerald-100 text-emerald-600'
        : 'bg-slate-200 text-slate-600';

    const accountStatusTone = status => status === 'å·²è¿æ¥'
        ? 'text-emerald-600'
        : 'text-rose-500';

    const nowString = () => new Date().toLocaleString('zh-CN', { hour12: false });

    const timeString = () => {
        const now = new Date();
        return `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
    };

    const buildDefaultFields = (indicator) => {
        const def = indicatorDefinitions[indicator];
        if (!def) return {};
        return def.fields.reduce((acc, field) => {
            acc[field.name] = field.default ?? '';
            return acc;
        }, {});
    };

    const createSignal = (section) => {
        globalSignalSeed += 1;
        const defaultIndicator = 'sar';
        return {
            id: `${section}-${globalSignalSeed}`,
            indicator: defaultIndicator,
            params: buildDefaultFields(defaultIndicator)
        };
    };

    const buildDefaultPositionValues = (formula) => {
        const config = positionConfigs[formula] ?? [];
        return config.reduce((acc, field) => {
            acc[field.name] = field.default ?? '';
            return acc;
        }, {});
    };

    const oppositeDirection = (direction) => direction === 'long' ? 'short' : 'long';

    const sarConditionText = (direction) => direction === 'long' ? 'Kçº¿ä¸Šç©¿ SAR' : 'Kçº¿ä¸‹ç©¿ SAR';

    const createStrategyRuntimeState = (strategy) => {
        const attackDirection = strategy?.directions?.attack ?? 'long';
        const defenseDirection = strategy?.directions?.defense ?? oppositeDirection(attackDirection);
        return {
            attackPosition: null,
            defensePosition: null,
            nextAttackDirection: attackDirection,
            nextDefenseDirection: defenseDirection,
            waitingDefenseSignal: false,
            defenseSarEnabled: Boolean(defenseDirection)
        };
    };

    const createPositionSnapshot = (strategy, direction) => {
        const asset = strategy.asset ?? 'BTC';
        const symbol = `${asset}-USDT`;
        const amount = asset === 'BTC'
            ? parseFloat((Math.random() * 0.05 + 0.01).toFixed(3))
            : parseFloat((Math.random() * 3 + 1).toFixed(2));
        const basePrice = asset === 'BTC'
            ? 28000 + Math.random() * 1000
            : asset === 'ETH'
                ? 1800 + Math.random() * 100
                : 100 + Math.random() * 20;
        const openPrice = parseFloat(basePrice.toFixed(2));
        return {
            direction,
            symbol,
            amount,
            amountDisplay: `${amount} ${asset}`,
            openPrice,
            openNotional: parseFloat((openPrice * amount).toFixed(2)),
            openedAt: nowString()
        };
    };

    const closePositionSnapshot = (position) => {
        const drift = Math.random() * 200 - 80;
        let closePrice = parseFloat((position.openPrice + drift).toFixed(2));
        if (closePrice <= 0) {
            closePrice = Math.max(1, parseFloat((position.openPrice + Math.abs(drift)).toFixed(2)));
        }
        const pnlRaw = (closePrice - position.openPrice) * position.amount * (position.direction === 'long' ? 1 : -1);
        return {
            closePrice: parseFloat(closePrice.toFixed(2)),
            pnl: parseFloat(pnlRaw.toFixed(2))
        };
    };

    const randomRemark = (context) => {
        const pool = context === 'defense'
            ? ['å¯¹å†²ä»‹å…¥', 'é£é™©ç¼“é‡Š', 'åå‘ä¿æŠ¤', 'åŠ¨æ€è°ƒä»“']
            : ['è¶‹åŠ¿å…¥åœº', 'SAR åè½¬', 'çªç ´è·Ÿè¿›', 'é¡ºåŠ¿åŠ ä»“'];
        return pool[Math.floor(Math.random() * pool.length)];
    };

    const invertSarCondition = (condition) => {
        if (condition === 'Kçº¿ä¸Šç©¿') return 'Kçº¿ä¸‹ç©¿';
        if (condition === 'Kçº¿ä¸‹ç©¿') return 'Kçº¿ä¸Šç©¿';
        return condition;
    };

    const StrategySectionTitle = ({ icon, text }) => (
        <h2 className="text-lg font-semibold text-slate-800 flex items-center gap-2 pb-3 border-b border-slate-200">
            <span className="text-xl">{icon}</span>
            {text}
        </h2>
    );

    const Sidebar = ({ activePage, onSelect }) => (
        <aside className="w-56 bg-slate-900 text-slate-100 flex flex-col">
            <div className="px-6 py-6 text-xl font-semibold border-b border-slate-800">
                OKX é‡åŒ–
            </div>
            <nav className="flex-1 py-4 space-y-1">
                {navItems.map(item => (
                    <button
                        key={item.id}
                        onClick={() => onSelect(item.id)}
                        className={[
                            'w-full text-left px-6 py-3 transition-colors border-l-4',
                            activePage === item.id
                                ? 'bg-slate-800 border-emerald-400 text-white'
                                : 'border-transparent hover:bg-slate-800/60'
                        ].join(' ')}
                    >
                        {item.label}
                    </button>
                ))}
            </nav>
        </aside>
    );

    const StatsCard = ({ label, value, change, tone }) => (
        <div className={`rounded-xl text-white p-5 shadow ${tone}`}>
            <div className="text-xs uppercase tracking-wide opacity-90">{label}</div>
            <div className="text-3xl font-semibold my-2">{value}</div>
            <div className="text-sm opacity-90">{change}</div>
        </div>
    );

    const StrategyTable = ({ strategies, onSimulate }) => (
        <div className="mt-6 bg-white rounded-xl shadow border border-slate-200 overflow-hidden">
            <table className="w-full text-sm">
                <thead className="bg-slate-900 text-white">
                <tr>
                    <th className="px-4 py-3 text-left font-medium">ç­–ç•¥åç§°</th>
                    <th className="px-4 py-3 text-left font-medium">å…³è”è´¦å·</th>
                    <th className="px-4 py-3 text-left font-medium">è¿›æ”»ç­–ç•¥</th>
                    <th className="px-4 py-3 text-left font-medium">é˜²å®ˆç­–ç•¥</th>
                    <th className="px-4 py-3 text-left font-medium">åˆ›å»ºæ—¶é—´</th>
                    <th className="px-4 py-3 text-left font-medium">æ“ä½œ</th>
                </tr>
                </thead>
                <tbody>
                {strategies.map(strategy => (
                    <tr key={strategy.name} className="border-b border-slate-200 last:border-none hover:bg-slate-50">
                        <td className="px-4 py-3 font-medium text-slate-800">{strategy.name}</td>
                        <td className="px-4 py-3 space-x-2">
                            {strategy.accounts.map(acc => (
                                <span key={acc} className="inline-block bg-emerald-100 text-emerald-700 text-xs font-semibold px-3 py-1 rounded-full">
                                    {acc}
                                </span>
                            ))}
                        </td>
                        <td className="px-4 py-3">
                            <span className={`inline-flex px-3 py-1 rounded-full text-xs font-semibold ${statusTone(strategy.status.attack)}`}>
                                {strategy.status.attack}
                            </span>
                        </td>
                        <td className="px-4 py-3">
                            <span className={`inline-flex px-3 py-1 rounded-full text-xs font-semibold ${statusTone(strategy.status.defense)}`}>
                                {strategy.status.defense}
                            </span>
                        </td>
                        <td className="px-4 py-3 text-slate-500">{strategy.createdAt}</td>
                        <td className="px-4 py-3 space-x-2">
                            <button
                                onClick={() => onSimulate(strategy, 'attack')}
                                className="px-3 py-1.5 text-xs font-semibold rounded bg-emerald-500 text-white hover:bg-emerald-600 transition"
                            >
                                æ¨¡æ‹Ÿè§¦å‘
                            </button>
                            <button className="px-3 py-1.5 text-xs font-semibold rounded bg-slate-200 text-slate-700 hover:bg-slate-300 transition">
                                ç¼–è¾‘
                            </button>
                            <button className="px-3 py-1.5 text-xs font-semibold rounded bg-rose-500 text-white hover:bg-rose-600 transition">
                                åˆ é™¤
                            </button>
                        </td>
                    </tr>
                ))}
                </tbody>
            </table>
        </div>
    );

    const Dashboard = ({ stats, strategies, onNavigate, onSimulate }) => (
        <div className="p-8 space-y-6">
            <div className="flex items-center justify-between">
                <h1 className="text-2xl font-semibold text-slate-900">ç­–ç•¥ç®¡ç†</h1>
                <button
                    onClick={() => onNavigate('strategy-config')}
                    className="px-4 py-2 rounded-lg bg-emerald-500 text-white font-semibold hover:bg-emerald-600 transition"
                >
                    + æ–°å»ºç­–ç•¥
                </button>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <StatsCard label="ä»Šæ—¥äº¤æ˜“æ¬¡æ•°" value={stats.totalTrades} change="è¾ƒæ˜¨æ—¥ +3" tone="bg-gradient-to-br from-indigo-500 to-purple-500" />
                <StatsCard label="æŒä»“æ•°" value={stats.openPositions} change="æµ®åŠ¨ç›ˆäº +$45.20" tone="bg-gradient-to-br from-emerald-500 to-teal-400" />
            </div>
            <StrategyTable strategies={strategies} onSimulate={onSimulate} />
        </div>
    );

    const ExecutionTable = ({ executions }) => (
        <div className="mt-6 bg-white rounded-xl shadow border border-slate-200 overflow-hidden">
            <table className="w-full text-sm">
                <thead className="bg-slate-900 text-white">
                <tr>
                    <th className="px-4 py-3 text-left font-medium">æ—¶é—´</th>
                    <th className="px-4 py-3 text-left font-medium">è´¦å·</th>
                    <th className="px-4 py-3 text-left font-medium">ç­–ç•¥åç§°</th>
                    <th className="px-4 py-3 text-left font-medium">ç­–ç•¥ç±»å‹</th>
                    <th className="px-4 py-3 text-left font-medium">äº¤æ˜“å¯¹</th>
                    <th className="px-4 py-3 text-left font-medium">æ–¹å‘</th>
                    <th className="px-4 py-3 text-left font-medium">æ•°é‡</th>
                    <th className="px-4 py-3 text-left font-medium">å¼€ä»“ä»·æ ¼</th>
                    <th className="px-4 py-3 text-left font-medium">å¹³ä»“ä»·æ ¼</th>
                    <th className="px-4 py-3 text-left font-medium">ç›ˆäº</th>
                    <th className="px-4 py-3 text-left font-medium">å¤‡æ³¨</th>
                </tr>
                </thead>
                <tbody>
                {executions.map(row => (
                    <tr key={row.id} className="border-b border-slate-200 last:border-none hover:bg-slate-50">
                        <td className="px-4 py-3 text-slate-500">{row.time}</td>
                        <td className="px-4 py-3">
                            <span className="inline-block bg-slate-200 text-slate-700 text-xs font-semibold px-3 py-1 rounded-full">{row.account}</span>
                        </td>
                        <td className="px-4 py-3 font-medium text-slate-800">{row.strategy}</td>
                        <td className="px-4 py-3 text-slate-600">{row.type}</td>
                        <td className="px-4 py-3">{row.symbol}</td>
                        <td className={`px-4 py-3 font-semibold ${directionTone(row.direction)}`}>{directionTexts[row.direction]}</td>
                        <td className="px-4 py-3">{row.amount}</td>
                        <td className="px-4 py-3">${row.open.toLocaleString()}</td>
                        <td className="px-4 py-3">${row.close.toLocaleString()}</td>
                        <td className={`px-4 py-3 font-semibold ${row.pnl >= 0 ? 'text-emerald-600' : 'text-rose-500'}`}>
                            {row.pnl >= 0 ? '+' : '-'}${Math.abs(row.pnl).toFixed(2)}
                        </td>
                        <td className="px-4 py-3 text-slate-500">{row.remark}</td>
                    </tr>
                ))}
                </tbody>
            </table>
        </div>
    );

    const ExecutionsPage = ({ executions }) => (
        <div className="p-8">
            <h1 className="text-2xl font-semibold text-slate-900">æ‰§è¡Œè®°å½•</h1>
            <div className="mt-6 grid gap-4 md:grid-cols-4">
                {[
                    { label: 'è´¦å·ç­›é€‰', options: ['å…¨éƒ¨è´¦å·', 'ä¸»è´¦å·', 'å¤‡ç”¨è´¦å·'] },
                    { label: 'ç­–ç•¥ç­›é€‰', options: ['å…¨éƒ¨ç­–ç•¥', 'BTC-SAR-çªç ´ç­–ç•¥', 'ETH-å‘¨æœŸæå€¼ç­–ç•¥'] },
                    { label: 'äº¤æ˜“æ–¹å‘', options: ['å…¨éƒ¨', 'å¼€å¤š', 'å¼€ç©º'] },
                    { label: 'æ—¶é—´èŒƒå›´', options: ['ä»Šæ—¥', 'è¿‘ 3 æ—¥', 'è¿‘ 7 æ—¥', 'è¿‘ 30 æ—¥'] }
                ].map(filter => (
                    <label key={filter.label} className="text-sm text-slate-600">
                        {filter.label}
                        <select className="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2">
                            {filter.options.map(option => (
                                <option key={option}>{option}</option>
                            ))}
                        </select>
                    </label>
                ))}
            </div>
            <ExecutionTable executions={executions} />
        </div>
    );

    const AccountCard = ({ account, onAssign }) => (
        <div className="bg-white rounded-xl shadow border border-slate-200 p-6 space-y-5">
            <div className="flex flex-wrap items-center justify-between gap-4 border-b border-slate-200 pb-4">
                <div>
                    <div className="text-lg font-semibold text-slate-900">{account.name}</div>
                    <div className={`text-sm ${accountStatusTone(account.status)} font-medium mt-1`}>{account.status}</div>
                </div>
                <div className="flex gap-2">
                    <button
                        onClick={() => onAssign(account)}
                        className="px-3 py-1.5 text-xs font-semibold rounded bg-emerald-500 text-white hover:bg-emerald-600 transition"
                    >
                        åˆ†é…ç­–ç•¥
                    </button>
                    <button className="px-3 py-1.5 text-xs font-semibold rounded bg-slate-200 text-slate-700 hover:bg-slate-300 transition">
                        ç¼–è¾‘
                    </button>
                    <button className="px-3 py-1.5 text-xs font-semibold rounded bg-rose-500 text-white hover:bg-rose-600 transition">
                        åˆ é™¤
                    </button>
                </div>
            </div>

            <div className="grid md:grid-cols-3 gap-4 text-sm">
                <div>
                    <div className="text-slate-500">API Key</div>
                    <div className="font-semibold text-slate-800">{account.apiKey}</div>
                </div>
                <div>
                    <div className="text-slate-500">åˆ›å»ºæ—¶é—´</div>
                    <div className="font-semibold text-slate-800">{account.createdAt}</div>
                </div>
                <div>
                    <div className="text-slate-500">ä»Šæ—¥äº¤æ˜“</div>
                    <div className="font-semibold text-slate-800">{account.tradesToday} ç¬”</div>
                </div>
                <div>
                    <div className="text-slate-500">ä»Šæ—¥ç›ˆäº</div>
                    <div className={`font-semibold ${account.pnlToday.startsWith('+') ? 'text-emerald-600' : 'text-rose-500'}`}>
                        {account.pnlToday}
                    </div>
                </div>
                <div className="md:col-span-3">
                    <div className="text-slate-500 mb-2">å·²å…³è”ç­–ç•¥</div>
                    <div className="flex flex-wrap gap-2">
                        {account.strategies.map(strategy => (
                            <span key={strategy} className="inline-flex px-3 py-1 rounded-full bg-amber-100 text-amber-700 text-xs font-semibold">
                                {strategy}
                            </span>
                        ))}
                        {account.strategies.length === 0 && (
                            <span className="text-slate-400 text-sm">å°šæœªå…³è”ä»»ä½•ç­–ç•¥</span>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );

    const AccountsPage = ({ accounts, onAssign }) => (
        <div className="p-8 space-y-6">
            <div className="flex items-center justify-between">
                <h1 className="text-2xl font-semibold text-slate-900">è´¦å·ç®¡ç†</h1>
                <button className="px-4 py-2 rounded-lg bg-emerald-500 text-white font-semibold hover:bg-emerald-600 transition">
                    + æ·»åŠ æ–°è´¦å·
                </button>
            </div>
            <div className="grid gap-6">
                {accounts.map(account => (
                    <AccountCard key={account.name} account={account} onAssign={onAssign} />
                ))}
            </div>
        </div>
    );

    const SettingsPage = () => (
        <div className="p-8 space-y-6">
            <h1 className="text-2xl font-semibold text-slate-900">ç³»ç»Ÿè®¾ç½®</h1>
            <div className="grid lg:grid-cols-2 gap-6">
                <div className="bg-white rounded-xl shadow border border-slate-200 p-6 space-y-4">
                    <h2 className="text-lg font-semibold text-slate-800">äº¤æ˜“æ‰€é…ç½®</h2>
                    {[
                        { label: 'API Key', placeholder: 'è¯·è¾“å…¥ API Key' },
                        { label: 'Secret Key', placeholder: 'è¯·è¾“å…¥ Secret Key', type: 'password' },
                        { label: 'Passphrase', placeholder: 'è¯·è¾“å…¥ Passphrase', type: 'password' }
                    ].map(field => (
                        <label key={field.label} className="block text-sm text-slate-600">
                            {field.label}
                            <input
                                type={field.type ?? 'text'}
                                className="mt-2 w-full rounded-lg border border-slate-300 px-3 py-2"
                                placeholder={field.placeholder}
                            />
                        </label>
                    ))}
                    <button className="w-full mt-4 px-4 py-2 rounded-lg bg-emerald-500 text-white font-semibold hover:bg-emerald-600 transition">
                        ä¿å­˜é…ç½®
                    </button>
                </div>
                <div className="bg-white rounded-xl shadow border border-slate-200 p-6 space-y-4">
                    <h2 className="text-lg font-semibold text-slate-800">é€šçŸ¥ä¸é£æ§</h2>
                    <label className="flex items-center justify-between text-sm text-slate-600">
                        <span>é‚®ç®±é€šçŸ¥</span>
                        <input type="checkbox" className="h-4 w-4" defaultChecked />
                    </label>
                    <label className="flex items-center justify-between text-sm text-slate-600">
                        <span>çŸ­ä¿¡é€šçŸ¥</span>
                        <input type="checkbox" className="h-4 w-4" />
                    </label>
                    <label className="block text-sm text-slate-600">
                        æœ€å¤§å›æ’¤è­¦æŠ¥ (%)
                        <input type="number" className="mt-2 w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="ä¾‹å¦‚ï¼š15" />
                    </label>
                    <button className="w-full mt-4 px-4 py-2 rounded-lg bg-slate-900 text-white font-semibold hover:bg-slate-800 transition">
                        ä¿å­˜è®¾ç½®
                    </button>
                </div>
            </div>
        </div>
    );

    const SignalItem = ({ index, data, onChangeIndicator, onChangeField, onRemove, canRemove, sectionType }) => {
        const definition = indicatorDefinitions[data.indicator];
        return (
            <div className="bg-white border border-slate-200 rounded-lg p-4 space-y-4 shadow-sm">
                <div className="flex items-center justify-between border-b border-slate-200 pb-3">
                    <span className="text-sm font-semibold text-emerald-600">ä¿¡å· #{index}</span>
                    <button
                        onClick={onRemove}
                        className={`text-xs font-semibold px-2 py-1 rounded ${canRemove ? 'bg-rose-100 text-rose-600 hover:bg-rose-200 transition' : 'bg-slate-100 text-slate-400 cursor-not-allowed'}`}
                        disabled={!canRemove}
                    >
                        åˆ é™¤
                    </button>
                </div>
                <div className="grid md:grid-cols-2 gap-4">
                    <label className="text-sm text-slate-600">
                        æŒ‡æ ‡é€‰æ‹©
                        <select
                            value={data.indicator}
                            onChange={e => onChangeIndicator(e.target.value)}
                            className="mt-2 w-full rounded-lg border border-slate-300 px-3 py-2 bg-white"
                        >
                            {Object.entries(indicatorDefinitions).map(([key, value]) => (
                                <option key={key} value={key}>{value.name}</option>
                            ))}
                        </select>
                    </label>
                    {definition?.fields?.map(field => (
                        <label key={field.name} className="text-sm text-slate-600">
                            {field.label}
                            {field.type === 'select' ? (
                                (() => {
                                    const isSarCondition = data.indicator === 'sar' && field.name === 'condition';
                                    let baseOptions = field.options || [];
                                    // é˜²å®ˆç­–ç•¥ä¸éœ€è¦'ä¸Šç©¿æˆ–ä¸‹ç©¿'é€‰é¡¹
                                    if (sectionType === 'defense' && isSarCondition) {
                                        baseOptions = baseOptions.filter(opt => opt !== 'ä¸Šç©¿æˆ–ä¸‹ç©¿');
                                    }
                                    const extraOptions = sectionType === 'defense' && isSarCondition ? ['è¿›æ”»æ–¹å‘ç›¸å'] : [];
                                    const options = [...baseOptions, ...extraOptions];
                                    return (
                                        <select
                                            value={data.params[field.name] ?? ''}
                                            onChange={e => onChangeField(field.name, e.target.value)}
                                            className="mt-2 w-full rounded-lg border border-slate-300 px-3 py-2 bg-white"
                                        >
                                            {options.map(option => (
                                                <option key={option} value={option}>{option}</option>
                                            ))}
                                        </select>
                                    );
                                })()
                            ) : (
                                <input
                                    type="number"
                                    value={data.params[field.name] ?? ''}
                                    onChange={e => onChangeField(field.name, e.target.value)}
                                    className="mt-2 w-full rounded-lg border border-slate-300 px-3 py-2"
                                    step={field.step}
                                    min={field.min}
                                    max={field.max}
                                />
                            )}
                        </label>
                    ))}
                </div>
            </div>
        );
    };

    const SignalsSection = ({ title, type, signals, onAdd, onIndicatorChange, onFieldChange, onRemove }) => (
        <div className="space-y-4">
            <StrategySectionTitle icon={type === 'attack' ? 'ğŸ¯' : 'ğŸ›¡ï¸'} text={title} />
            <label className="block text-sm text-slate-600">
                K çº¿å‘¨æœŸ
                <select className="mt-2 w-full rounded-lg border border-slate-300 px-3 py-2 bg-white">
                    {['1åˆ†é’Ÿ', '5åˆ†é’Ÿ', '15åˆ†é’Ÿ', '30åˆ†é’Ÿ', '1å°æ—¶', '4å°æ—¶', '1æ—¥'].map(option => (
                        <option key={option} value={option}>{option}</option>
                    ))}
                </select>
            </label>
            <div className="space-y-4">
                {signals.map((signal, index) => (
                    <SignalItem
                        key={signal.id}
                        index={index + 1}
                        data={signal}
                        sectionType={type}
                        onChangeIndicator={(indicator) => onIndicatorChange(type, signal.id, indicator)}
                        onChangeField={(field, value) => onFieldChange(type, signal.id, field, value)}
                        onRemove={() => onRemove(type, signal.id)}
                        canRemove={signals.length > 1}
                    />
                ))}
            </div>
            <button
                onClick={() => onAdd(type)}
                className="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-dashed border-emerald-300 text-emerald-600 hover:border-emerald-500 hover:text-emerald-700 transition text-sm font-semibold"
            >
                + æ·»åŠ ä¿¡å·
            </button>
        </div>
    );

    const PositionParams = ({ type, formula, values, onFormulaChange, onFieldChange }) => {
        const config = positionConfigs[formula] ?? [];
        return (
            <div className="space-y-4">
                <label className="block text-sm text-slate-600">
                    ä»“ä½ç®¡ç†
                    <select
                        value={formula}
                        onChange={e => onFormulaChange(type, e.target.value)}
                        className="mt-2 w-full rounded-lg border border-slate-300 px-3 py-2 bg-white"
                    >
                        <option value="kelly">å‡¯åˆ©å…¬å¼</option>
                        <option value="fixed-ratio">å›ºå®šæ¯”ä¾‹</option>
                        <option value="fixed-amount">å›ºå®šé‡‘é¢</option>
                        <option value="atr">ATR åŠ¨æ€ä»“ä½</option>
                    </select>
                </label>
                <div className="bg-white border border-slate-200 rounded-lg p-4 shadow-sm space-y-3">
                    <div className="text-sm font-semibold text-slate-700">ä»“ä½å‚æ•°</div>
                    <div className="grid md:grid-cols-2 gap-4">
                        {config.map(field => (
                            <label key={field.name} className="text-sm text-slate-600">
                                {field.label}
                                <input
                                    type="number"
                                    value={values[field.name] ?? ''}
                                    onChange={e => onFieldChange(type, field.name, e.target.value)}
                                    className="mt-2 w-full rounded-lg border border-slate-300 px-3 py-2"
                                    step={field.step}
                                    min={field.min}
                                    max={field.max}
                                />
                            </label>
                        ))}
                    </div>
                </div>
            </div>
        );
    };

    const StrategyLinkageSummary = ({ attackSignals, defenseSignals, attackDirection, defenseDirection }) => {
        const attackSarSignals = attackSignals.filter(signal => signal.indicator === 'sar');
        if (attackSarSignals.length === 0) {
            return (
                <div className="bg-white border border-slate-200 rounded-xl shadow p-6 space-y-5">
                    <StrategySectionTitle icon="ğŸ”—" text="ç­–ç•¥è”åŠ¨è¯´æ˜" />
                    <div className="text-sm text-slate-600 leading-relaxed">
                        å½“å‰è¿›æ”»ç­–ç•¥æœªé…ç½®æŠ›ç‰©çº¿è½¬å‘æŒ‡æ ‡ï¼ˆSARï¼‰ï¼Œæš‚æ— æ³•ç”Ÿæˆè¿›æ”»ä¸é˜²å®ˆçš„è”åŠ¨æè¿°ã€‚
                    </div>
                </div>
            );
        }

        const defenseSarSignals = defenseSignals.filter(signal => signal.indicator === 'sar');
        const hasDefenseSar = defenseSarSignals.length > 0;

        const getConditionText = (signals) => signals[0]?.params?.condition ?? 'Kçº¿ä¸Šç©¿';
        const attackConditionText = getConditionText(attackSarSignals);
        const defenseConditionText = getConditionText(defenseSarSignals);
        const attackDirectionText = attackDirection === 'long' ? 'åšå¤š' : (attackDirection === 'short' ? 'åšç©º' : 'è‡ªåŠ¨');
        const computedDefenseDirectionText = defenseDirection === 'long' ? 'åšå¤š' : 'åšç©º';
        const defenseDirectionText = attackDirection === 'auto' ? 'è‡ªåŠ¨' : computedDefenseDirectionText;
        const oppositeAttackCondition = invertSarCondition(attackConditionText);
        const oppositeAttackDirectionText = attackDirection === 'long' ? 'åšç©º' : (attackDirection === 'short' ? 'åšå¤š' : 'è‡ªåŠ¨');

        const summary = [
            `å½“è¿›æ”»ç­–ç•¥çš„ SAR ä¿¡å·ï¼ˆ${attackConditionText}ï¼‰è¢«è§¦å‘æ—¶ï¼Œç³»ç»Ÿä¼šæŒ‰ç…§å½“å‰è¿›æ”»æ–¹å‘ï¼ˆ${attackDirectionText}ï¼‰è‡ªåŠ¨å¼€ä»“ã€‚`,
            hasDefenseSar
                ? `è‹¥é˜²å®ˆç­–ç•¥ä¹Ÿå¯ç”¨äº† SAR ä¿¡å·ï¼Œç³»ç»Ÿä¼šç«‹å³å¹³æ‰å·²æœ‰çš„é˜²å®ˆä»“ä½ï¼Œå¹¶è¿›å…¥ç­‰å¾…é˜²å®ˆä¿¡å·ï¼ˆ${defenseConditionText}ï¼‰çš„çŠ¶æ€ã€‚`
                : `å½“å‰é˜²å®ˆç­–ç•¥æœªå¯ç”¨ SAR ä¿¡å·ï¼Œè¿›æ”»ä¿¡å·è§¦å‘åä¸ä¼šè‡ªåŠ¨å¤„ç†é˜²å®ˆä»“ä½ã€‚`,
            hasDefenseSar
                ? `å½“é˜²å®ˆ SAR ç›‘æµ‹åˆ° ${defenseConditionText} æ—¶ï¼Œå°†æŒ‰ç…§é˜²å®ˆæ–¹å‘ï¼ˆ${defenseDirectionText}ï¼‰æ‰§è¡Œå¼€ä»“ï¼Œä¸è¿›æ”»æŒä»“å½¢æˆå¯¹å†²ã€‚`
                : null,
            `å½“è¿›æ”»ä¿¡å·åå‘ï¼ˆ${oppositeAttackCondition}ï¼‰è§¦å‘æ—¶ï¼Œç³»ç»Ÿä¼šå¹³æ‰é˜²å®ˆä»“ä½ï¼Œå¹¶å‡†å¤‡å¯»æ‰¾ä¸‹ä¸€æ¬¡${oppositeAttackDirectionText}çš„æœºä¼šã€‚`
        ].filter(Boolean);

        const chainNodes = [
            {
                key: 'attack-trigger',
                title: 'è¿›æ”»è§¦å‘',
                detail: `SAR ${attackConditionText} â†’ ${attackDirectionText} å¼€ä»“`
            },
            {
                key: 'defense-close',
                title: 'é˜²å®ˆå¹³ä»“',
                detail: hasDefenseSar
                    ? 'ç«‹åˆ»å¹³æ‰é˜²å®ˆä»“ä½ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€'
                    : 'æœªå¯ç”¨é˜²å®ˆ SARï¼Œè·³è¿‡è‡ªåŠ¨å¹³ä»“'
            },
            {
                key: 'defense-entry',
                title: 'é˜²å®ˆåå‘',
                detail: hasDefenseSar
                    ? `ç­‰å¾… ${defenseConditionText} â†’ ${defenseDirectionText} å¼€ä»“`
                    : 'æ— é˜²å®ˆ SAR ä¿¡å·'
            },
            {
                key: 'reset-cycle',
                title: 'å¾ªç¯é‡ç½®',
                detail: `è¿›æ”»è½¬ä¸º ${oppositeAttackCondition} â†’ é˜²å®ˆå¹³ä»“ â†’ å¾… ${oppositeAttackDirectionText}`
            }
        ];

        return (
            <div className="bg-white border border-slate-200 rounded-xl shadow p-6 space-y-5">
                <StrategySectionTitle icon="ğŸ”—" text="ç­–ç•¥è”åŠ¨è¯´æ˜" />
                <div className="space-y-3 text-sm text-slate-600">
                    {summary.map((line, index) => (
                        <div key={`summary-${index}`} className="flex items-start gap-2">
                            <span className="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-100 text-emerald-600 text-xs font-semibold">
                                {index + 1}
                            </span>
                            <span className="flex-1 leading-relaxed">{line}</span>
                        </div>
                    ))}
                </div>
                <div>
                    <div className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3">è”åŠ¨é“¾</div>
                    <div className="flex flex-wrap md:flex-nowrap items-stretch gap-3">
                        {chainNodes.map((node, index) => (
                            <React.Fragment key={node.key}>
                                <div className="flex-1 min-w-[180px] bg-emerald-50 border border-emerald-200 rounded-lg p-4 shadow-sm">
                                    <div className="text-sm font-semibold text-emerald-700">{node.title}</div>
                                    <div className="mt-2 text-xs text-emerald-600 leading-relaxed">
                                        {node.detail}
                                    </div>
                                </div>
                                {index < chainNodes.length - 1 && (
                                    <div className="hidden md:flex items-center text-emerald-400 text-lg">
                                        âœ
                                    </div>
                                )}
                            </React.Fragment>
                        ))}
                    </div>
                </div>
            </div>
        );
    };

    const StrategyConfigPage = ({
        strategyForm,
        onFormChange,
        selectedAccounts,
        onToggleAccount,
        signals,
        onAddSignal,
        onSignalIndicator,
        onSignalField,
        onRemoveSignal,
        positionValues,
        onFormulaChange,
        onPositionFieldChange,
        onSave
    }) => {
        const defenseDirection = strategyForm.attackDirection === 'long' ? 'short' : 'long';
        return (
            <div className="p-8 space-y-6">
                <h1 className="text-2xl font-semibold text-slate-900">ç­–ç•¥é…ç½®</h1>
                <div className="grid lg:grid-cols-3 gap-6">
                    <div className="lg:col-span-2 space-y-6">
                        <div className="bg-white border border-slate-200 rounded-xl shadow p-6 space-y-4">
                            <label className="block text-sm text-slate-600">
                                ç­–ç•¥åç§°
                                <input
                                    value={strategyForm.name}
                                    onChange={e => onFormChange('name', e.target.value)}
                                    className="mt-2 w-full rounded-lg border border-slate-300 px-3 py-2"
                                    placeholder="è¯·è¾“å…¥ç­–ç•¥åç§°"
                                />
                            </label>
                            <div>
                                <div className="text-sm text-slate-600 mb-2">å…³è”è´¦å·ï¼ˆå¯å¤šé€‰ï¼‰</div>
                                <div className="border border-slate-200 rounded-lg divide-y divide-slate-200 bg-white">
                                    {defaultAccounts.map(account => (
                                        <label key={account.name} className="flex items-center gap-3 px-4 py-2 hover:bg-slate-50">
                                            <input
                                                type="checkbox"
                                                className="h-4 w-4"
                                                checked={selectedAccounts.includes(account.name)}
                                                onChange={() => onToggleAccount(account.name)}
                                            />
                                            <span className="text-sm text-slate-700">{account.name}</span>
                                        </label>
                                    ))}
                                </div>
                                <div className="mt-3 rounded-lg bg-slate-50 border border-slate-200 px-3 py-2 min-h-[44px] text-sm text-slate-600">
                                    {selectedAccounts.length === 0
                                        ? 'æœªé€‰æ‹©ä»»ä½•è´¦å·'
                                        : selectedAccounts.map(acc => (
                                            <span key={acc} className="inline-flex px-2.5 py-1 rounded-full bg-emerald-100 text-emerald-600 text-xs font-semibold mr-2">
                                                {acc}
                                            </span>
                                        ))}
                                </div>
                            </div>
                        </div>

                        <div className="bg-white border border-slate-200 rounded-xl shadow p-6 space-y-6">
                            <SignalsSection
                                title="è¿›æ”»ç­–ç•¥é…ç½®"
                                type="attack"
                                signals={signals.attack}
                                onAdd={onAddSignal}
                                onIndicatorChange={onSignalIndicator}
                                onFieldChange={onSignalField}
                                onRemove={onRemoveSignal}
                            />

                            <div className="grid md:grid-cols-2 gap-4">
                                <label className="text-sm text-slate-600">
                                    å¼€ä»“æ–¹å‘
                                    <div className="mt-2 flex gap-4">
                                        {['long', 'short', 'auto'].map(direction => (
                                            <label key={direction} className="flex items-center gap-2 text-sm text-slate-700">
                                                <input
                                                    type="radio"
                                                    name="attackDirection"
                                                    value={direction}
                                                    checked={strategyForm.attackDirection === direction}
                                                    onChange={e => onFormChange('attackDirection', e.target.value)}
                                                    disabled={true}
                                                />
                                                {directionTexts[direction]}
                                            </label>
                                        ))}
                                    </div>
                                </label>
                                <label className="text-sm text-slate-600">
                                    æ æ†å€æ•°
                                    <div className="mt-2 flex items-center gap-2">
                                        <input
                                            type="number"
                                            min="1"
                                            step="1"
                                            value={strategyForm.attackLeverage}
                                            onChange={e => onFormChange('attackLeverage', e.target.value)}
                                            className="w-full rounded-lg border border-slate-300 px-3 py-2"
                                        />
                                        <span className="px-3 py-2 rounded-lg bg-slate-200 text-slate-600 text-sm font-semibold">x</span>
                                    </div>
                                </label>
                            </div>

                            <PositionParams
                                type="attack"
                                formula={strategyForm.attackFormula}
                                values={positionValues.attack}
                                onFormulaChange={onFormulaChange}
                                onFieldChange={onPositionFieldChange}
                            />
                        </div>

                        <div className="bg-white border border-slate-200 rounded-xl shadow p-6 space-y-6">
                            <SignalsSection
                                title="é˜²å®ˆç­–ç•¥é…ç½®"
                                type="defense"
                                signals={signals.defense}
                                onAdd={onAddSignal}
                                onIndicatorChange={onSignalIndicator}
                                onFieldChange={onSignalField}
                                onRemove={onRemoveSignal}
                            />

                            <div className="grid md:grid-cols-2 gap-4">
                                <div className="text-sm text-slate-600">
                                    å¼€ä»“æ–¹å‘
                                    <div className="mt-2 rounded-lg border border-slate-200 bg-slate-50 px-3 py-3 text-slate-600">
                                        é˜²å®ˆç­–ç•¥å¼€ä»“æ–¹å‘è‡ªåŠ¨ä¸è¿›æ”»ç­–ç•¥ç›¸åï¼Œå½“å‰æ–¹å‘ï¼š
                                        <span className={`ml-2 font-semibold ${strategyForm.attackDirection === 'auto' ? 'text-slate-600' : directionTone(defenseDirection)}`}>
                                            {strategyForm.attackDirection === 'auto' ? 'è‡ªåŠ¨' : directionTexts[defenseDirection]}
                                        </span>
                                    </div>
                                </div>
                                <label className="text-sm text-slate-600">
                                    æ æ†å€æ•°
                                    <div className="mt-2 flex items-center gap-2">
                                        <input
                                            type="number"
                                            min="1"
                                            step="1"
                                            value={strategyForm.defenseLeverage}
                                            onChange={e => onFormChange('defenseLeverage', e.target.value)}
                                            className="w-full rounded-lg border border-slate-300 px-3 py-2"
                                        />
                                        <span className="px-3 py-2 rounded-lg bg-slate-200 text-slate-600 text-sm font-semibold">x</span>
                                    </div>
                                </label>
                            </div>

                            <PositionParams
                                type="defense"
                                formula={strategyForm.defenseFormula}
                                values={positionValues.defense}
                                onFormulaChange={onFormulaChange}
                                onFieldChange={onPositionFieldChange}
                            />
                        </div>

                        <StrategyLinkageSummary
                            attackSignals={signals.attack}
                            defenseSignals={signals.defense}
                            attackDirection={strategyForm.attackDirection}
                            defenseDirection={defenseDirection}
                        />

                        <div className="flex gap-3">
                            <button
                                onClick={onSave}
                                className="px-4 py-2 rounded-lg bg-emerald-500 text-white font-semibold hover:bg-emerald-600 transition"
                            >
                                ä¿å­˜ç­–ç•¥
                            </button>
                            <button className="px-4 py-2 rounded-lg bg-slate-200 text-slate-700 font-semibold hover:bg-slate-300 transition">
                                å–æ¶ˆ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    const LogEntry = ({ entry }) => (
        <div className="bg-white border border-slate-200 rounded-lg p-4 shadow-sm space-y-2">
            <div className="text-xs text-slate-400">{entry.timestamp}</div>
            <div className="text-sm font-semibold text-slate-700">
                {entry.account} Â· {entry.strategy}{entry.type ? ` Â· ${entry.type}` : ''}
            </div>
            <div className="text-sm text-slate-600">{entry.message}</div>
            {entry.details?.length > 0 && (
                <div className="pt-2 border-t border-slate-200 text-xs text-slate-500 flex flex-wrap gap-3">
                    {entry.details.map((detail, idx) => (
                        <div key={`${detail.label}-${idx}`} className="flex items-center gap-1">
                            <span className="text-slate-400">{detail.label}:</span>
                            <span className={detail.tone ? directionTone(detail.tone === 'long' ? 'long' : 'short') : 'text-slate-600'}>
                                {detail.value}
                            </span>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );

    const InfoPanel = ({ logs }) => (
        <aside className="w-96 bg-slate-50 border-l border-slate-200 p-6 overflow-y-auto hidden xl:block">
            <h3 className="text-lg font-semibold text-slate-900 mb-4">å®æ—¶è¿è¡Œæ—¥å¿—</h3>
            <div className="space-y-4">
                {logs.map(log => (
                    <LogEntry key={log.id} entry={log} />
                ))}
            </div>
        </aside>
    );

    const AssignStrategyModal = ({ isOpen, accountName, strategies, selected, onToggle, onClose, onSave }) => {
        if (!isOpen) return null;
        return (
            <div className="fixed inset-0 z-50 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center px-4">
                <div className="bg-white rounded-xl shadow-xl w-full max-w-xl p-6 space-y-4 border border-slate-200">
                    <div className="flex items-center justify-between border-b border-slate-200 pb-3">
                        <h2 className="text-xl font-semibold text-slate-900">
                            ä¸º <span className="text-emerald-600">{accountName}</span> åˆ†é…ç­–ç•¥
                        </h2>
                        <button onClick={onClose} className="text-slate-400 hover:text-slate-600 text-2xl leading-none">
                            &times;
                        </button>
                    </div>
                    <div className="space-y-3 max-h-72 overflow-y-auto pr-2">
                        {strategies.map(strategy => (
                            <label
                                key={strategy.name}
                                className="flex items-center gap-3 p-3 border border-slate-200 rounded-lg hover:border-emerald-400 hover:bg-emerald-50 transition"
                            >
                                <input
                                    type="checkbox"
                                    className="h-4 w-4"
                                    checked={selected.includes(strategy.name)}
                                    onChange={() => onToggle(strategy.name)}
                                />
                                <div className="flex-1">
                                    <div className="text-sm font-semibold text-slate-800">{strategy.name}</div>
                                    <div className="text-xs text-slate-500 mt-1">åˆ›å»ºæ—¶é—´ {strategy.createdAt}</div>
                                </div>
                                <span className={`text-xs font-semibold px-2 py-1 rounded-full ${statusTone(strategy.status.attack)}`}>
                                    {strategy.status.attack}
                                </span>
                            </label>
                        ))}
                    </div>
                    <div className="flex gap-3">
                        <button
                            onClick={onSave}
                            className="flex-1 px-4 py-2 rounded-lg bg-emerald-500 text-white font-semibold hover:bg-emerald-600 transition"
                        >
                            ä¿å­˜å…³è”
                        </button>
                        <button
                            onClick={onClose}
                            className="flex-1 px-4 py-2 rounded-lg bg-slate-200 text-slate-700 font-semibold hover:bg-slate-300 transition"
                        >
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    function App() {
        const [activePage, setActivePage] = useState('dashboard');
        const [stats, setStats] = useState({ totalTrades: 12, openPositions: 3 });
        const [strategies, setStrategies] = useState(defaultStrategies);
        const [accounts, setAccounts] = useState(defaultAccounts);
        const [logs, setLogs] = useState(initialLogs);
        const [executions, setExecutions] = useState(initialExecutions);
        const [signals, setSignals] = useState({
            attack: [createSignal('attack')],
            defense: [createSignal('defense')]
        });
        const [strategyRuntime, setStrategyRuntime] = useState({});
        const [strategyForm, setStrategyForm] = useState({
            name: '',
            selectedAccounts: [],
            attackDirection: 'long',
            attackLeverage: 10,
            defenseLeverage: 5,
            attackFormula: 'kelly',
            defenseFormula: 'kelly'
        });
        const [positionValues, setPositionValues] = useState({
            attack: buildDefaultPositionValues('kelly'),
            defense: buildDefaultPositionValues('kelly')
        });
        const [modalState, setModalState] = useState({
            open: false,
            account: null,
            selected: []
        });

        const logCounter = useRef(initialLogs.length);
        const executionCounter = useRef(initialExecutions.length);

        const addLog = (entry) => {
            logCounter.current += 1;
            setLogs(prev => [{ id: logCounter.current, ...entry }, ...prev]);
        };

        const addExecution = (entry) => {
            executionCounter.current += 1;
            setExecutions(prev => [{ id: executionCounter.current, ...entry }, ...prev]);
        };

                        const simulateStrategyTrigger = (strategy, type) => {
            const accountName = strategy.accounts[0] ?? 'ä¸»è´¦å·';
            const currentRuntime = strategyRuntime[strategy.name] ?? createStrategyRuntimeState(strategy);
            const runtime = {
                ...currentRuntime,
                attackPosition: currentRuntime.attackPosition ? { ...currentRuntime.attackPosition } : null,
                defensePosition: currentRuntime.defensePosition ? { ...currentRuntime.defensePosition } : null
            };

            if (strategyForm.name && strategy.name === strategyForm.name) {
                const hasDefenseSar = signals.defense.some(signal => signal.indicator === 'sar');
                runtime.defenseSarEnabled = hasDefenseSar;
                if (!hasDefenseSar) {
                    runtime.defensePosition = null;
                    runtime.waitingDefenseSignal = false;
                }
            }

            const logs = [];
            const executions = [];
            let tradeCount = 0;

            const pushLog = ({ type: logType, message, details = [] }) => {
                logs.push({
                    timestamp: nowString(),
                    account: accountName,
                    strategy: strategy.name,
                    type: logType,
                    message,
                    details
                });
            };

            const pushExecution = (payload) => {
                executions.push({
                    time: timeString(),
                    account: accountName,
                    strategy: strategy.name,
                    ...payload
                });
                tradeCount += 1;
            };

            if (type === 'attack') {
                const direction = runtime.nextAttackDirection ?? 'long';
                const condition = sarConditionText(direction);

                pushLog({
                    type: 'è¿›æ”»',
                    message: `ğŸ¯ è¿›æ”»ä¿¡å·è§¦å‘ï¼š${condition}`
                });

                if (runtime.attackPosition) {
                    const { closePrice, pnl } = closePositionSnapshot(runtime.attackPosition);
                    pushLog({
                        type: 'è¿›æ”»',
                        message: 'ğŸ”š è¿›æ”»ä»“ä½å¹³ä»“',
                        details: [
                            { label: 'å¹³ä»“ä»·æ ¼', value: `$${closePrice}` },
                            { label: 'ç›ˆäº', value: `${pnl >= 0 ? '+' : ''}${pnl} USDT` }
                        ]
                    });
                    pushExecution({
                        type: 'è¿›æ”»',
                        symbol: runtime.attackPosition.symbol,
                        direction: runtime.attackPosition.direction,
                        amount: runtime.attackPosition.amount.toString(),
                        open: runtime.attackPosition.openPrice,
                        close: closePrice,
                        pnl,
                        remark: 'è¿›æ”»ä¿¡å·åè½¬å¹³ä»“'
                    });
                    runtime.attackPosition = null;
                }

                const newAttackPosition = createPositionSnapshot(strategy, direction);
                runtime.attackPosition = newAttackPosition;
                runtime.nextAttackDirection = oppositeDirection(direction);

                pushLog({
                    type: 'è¿›æ”»',
                    message: `ğŸ›’ è¿›æ”»å¼€ä»“ï¼š${directionTexts[direction]} ${newAttackPosition.amountDisplay}`,
                    details: [
                        { label: 'äº¤æ˜“å“ç§', value: newAttackPosition.symbol },
                        { label: 'æ–¹å‘', value: directionTexts[direction], tone: direction },
                        { label: 'å¼€ä»“ä»·æ ¼', value: `$${newAttackPosition.openPrice}` }
                    ]
                });
                pushLog({
                    type: 'è¿›æ”»',
                    message: 'ğŸ’° è¿›æ”»è®¢å•æˆäº¤',
                    details: [
                        { label: 'æˆäº¤é‡‘é¢', value: `$${newAttackPosition.openNotional}` }
                    ]
                });
                pushExecution({
                    type: 'è¿›æ”»',
                    symbol: newAttackPosition.symbol,
                    direction,
                    amount: newAttackPosition.amount.toString(),
                    open: newAttackPosition.openPrice,
                    close: newAttackPosition.openPrice,
                    pnl: 0,
                    remark: randomRemark('attack')
                });

                if (runtime.defenseSarEnabled) {
                    if (runtime.defensePosition) {
                        const { closePrice, pnl } = closePositionSnapshot(runtime.defensePosition);
                        pushLog({
                            type: 'é˜²å®ˆ',
                            message: 'âš ï¸ é˜²å®ˆä»“ä½è¢«åŠ¨å¹³ä»“ï¼ˆè¿›æ”»ä¿¡å·åå‘ï¼‰',
                            details: [
                                { label: 'å¹³ä»“ä»·æ ¼', value: `$${closePrice}` },
                                { label: 'ç›ˆäº', value: `${pnl >= 0 ? '+' : ''}${pnl} USDT` }
                            ]
                        });
                        pushExecution({
                            type: 'é˜²å®ˆ',
                            symbol: runtime.defensePosition.symbol,
                            direction: runtime.defensePosition.direction,
                            amount: runtime.defensePosition.amount.toString(),
                            open: runtime.defensePosition.openPrice,
                            close: closePrice,
                            pnl,
                            remark: 'é˜²å®ˆä»“ä½è¢«åŠ¨å¹³ä»“'
                        });
                        runtime.defensePosition = null;
                    }
                    runtime.waitingDefenseSignal = true;
                    runtime.nextDefenseDirection = oppositeDirection(direction);
                    pushLog({
                        type: 'é˜²å®ˆ',
                        message: `ğŸ›¡ï¸ é˜²å®ˆè¿›å…¥å¾…å‘½ï¼šç­‰å¾… ${sarConditionText(runtime.nextDefenseDirection)}`
                    });
                }
            } else {
                const direction = runtime.nextDefenseDirection ?? oppositeDirection(runtime.nextAttackDirection ?? 'long');
                const condition = sarConditionText(direction);

                pushLog({
                    type: 'é˜²å®ˆ',
                    message: `ğŸ›¡ï¸ é˜²å®ˆä¿¡å·è§¦å‘ï¼š${condition}`
                });

                if (!runtime.defenseSarEnabled) {
                    pushLog({
                        type: 'é˜²å®ˆ',
                        message: 'â„¹ï¸ å½“å‰ç­–ç•¥æœªå¯ç”¨ SAR é˜²å®ˆé€»è¾‘ï¼Œå¿½ç•¥ä¿¡å·'
                    });
                } else if (runtime.waitingDefenseSignal) {
                    const newDefensePosition = createPositionSnapshot(strategy, direction);
                    runtime.defensePosition = newDefensePosition;
                    runtime.waitingDefenseSignal = false;
                    runtime.nextDefenseDirection = oppositeDirection(direction);

                    pushLog({
                        type: 'é˜²å®ˆ',
                        message: `âœ… é˜²å®ˆå¼€ä»“ï¼š${directionTexts[direction]} ${newDefensePosition.amountDisplay}`,
                        details: [
                            { label: 'äº¤æ˜“å“ç§', value: newDefensePosition.symbol },
                            { label: 'æ–¹å‘', value: directionTexts[direction], tone: direction },
                            { label: 'å¼€ä»“ä»·æ ¼', value: `$${newDefensePosition.openPrice}` }
                        ]
                    });
                    pushExecution({
                        type: 'é˜²å®ˆ',
                        symbol: newDefensePosition.symbol,
                        direction,
                        amount: newDefensePosition.amount.toString(),
                        open: newDefensePosition.openPrice,
                        close: newDefensePosition.openPrice,
                        pnl: 0,
                        remark: randomRemark('defense')
                    });
                } else if (runtime.defensePosition) {
                    pushLog({
                        type: 'é˜²å®ˆ',
                        message: 'â„¹ï¸ é˜²å®ˆä»“ä½å·²åœ¨è¿è¡Œï¼Œç»´æŒå½“å‰æŒä»“',
                        details: [
                            { label: 'æŒä»“æ–¹å‘', value: directionTexts[runtime.defensePosition.direction], tone: runtime.defensePosition.direction },
                            { label: 'å¼€ä»“ä»·æ ¼', value: `$${runtime.defensePosition.openPrice}` }
                        ]
                    });
                } else {
                    runtime.waitingDefenseSignal = true;
                    runtime.nextDefenseDirection = direction;
                }
            }

            setStrategyRuntime(prev => ({
                ...prev,
                [strategy.name]: runtime
            }));

            logs.forEach(addLog);
            executions.forEach(addExecution);

            if (tradeCount > 0) {
                setStats(prev => ({
                    ...prev,
                    totalTrades: prev.totalTrades + tradeCount
                }));
            }
        };

        const handleFormChange = (field, value) => {
            setStrategyForm(prev => ({
                ...prev,
                [field]: value
            }));
        };

        const handleAccountToggle = (accountName) => {
            setStrategyForm(prev => {
                const exists = prev.selectedAccounts.includes(accountName);
                return {
                    ...prev,
                    selectedAccounts: exists
                        ? prev.selectedAccounts.filter(acc => acc !== accountName)
                        : [...prev.selectedAccounts, accountName]
                };
            });
        };

        const handleAddSignal = (type) => {
            setSignals(prev => ({
                ...prev,
                [type]: [...prev[type], createSignal(type)]
            }));
        };

        const handleRemoveSignal = (type, id) => {
            setSignals(prev => ({
                ...prev,
                [type]: prev[type].length > 1 ? prev[type].filter(signal => signal.id !== id) : prev[type]
            }));
        };

        const handleSignalIndicatorChange = (type, id, indicator) => {
            setSignals(prev => ({
                ...prev,
                [type]: prev[type].map(signal => signal.id === id
                    ? { ...signal, indicator, params: buildDefaultFields(indicator) }
                    : signal)
            }));

            // Auto-update attack direction when SAR indicator is selected
            if (type === 'attack' && indicator === 'sar') {
                const defaultFields = buildDefaultFields(indicator);
                const condition = defaultFields.condition || 'Kçº¿ä¸Šç©¿';
                let newDirection = 'long';
                if (condition === 'Kçº¿ä¸Šç©¿') {
                    newDirection = 'long';
                } else if (condition === 'Kçº¿ä¸‹ç©¿') {
                    newDirection = 'short';
                } else if (condition === 'ä¸Šç©¿æˆ–ä¸‹ç©¿') {
                    newDirection = 'auto';
                }
                setStrategyForm(prev => ({
                    ...prev,
                    attackDirection: newDirection
                }));
            }
        };

        const handleSignalFieldChange = (type, id, field, value) => {
            setSignals(prev => ({
                ...prev,
                [type]: prev[type].map(signal => signal.id === id
                    ? { ...signal, params: { ...signal.params, [field]: value } }
                    : signal)
            }));

            // Auto-update attack direction based on SAR condition
            if (type === 'attack' && field === 'condition') {
                const signal = signals.attack.find(s => s.id === id);
                if (signal && signal.indicator === 'sar') {
                    let newDirection = 'auto';
                    if (value === 'Kçº¿ä¸Šç©¿') {
                        newDirection = 'long';
                    } else if (value === 'Kçº¿ä¸‹ç©¿') {
                        newDirection = 'short';
                    } else if (value === 'ä¸Šç©¿æˆ–ä¸‹ç©¿') {
                        newDirection = 'auto';
                    }
                    setStrategyForm(prev => ({
                        ...prev,
                        attackDirection: newDirection
                    }));
                }
            }
        };

        const handleFormulaChange = (type, formula) => {
            setStrategyForm(prev => ({
                ...prev,
                [`${type}Formula`]: formula
            }));
            setPositionValues(prev => ({
                ...prev,
                [type]: buildDefaultPositionValues(formula)
            }));
        };

        const handlePositionFieldChange = (type, field, value) => {
            setPositionValues(prev => ({
                ...prev,
                [type]: {
                    ...prev[type],
                    [field]: value
                }
            }));
        };

        const handleSaveStrategy = () => {
            if (!strategyForm.name.trim()) {
                alert('è¯·å¡«å†™ç­–ç•¥åç§°');
                return;
            }
            if (strategyForm.selectedAccounts.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè´¦å·');
                return;
            }
            alert(`ç­–ç•¥é…ç½®å·²ä¿å­˜ï¼Œå…³è”è´¦å·: ${strategyForm.selectedAccounts.join(', ')}`);
            addLog({
                timestamp: nowString(),
                account: 'ç³»ç»Ÿ',
                strategy: strategyForm.name || 'æ–°ç­–ç•¥',
                type: '',
                message: 'ğŸ“ æ–°ç­–ç•¥å·²åˆ›å»ºå¹¶ä¿å­˜',
                details: []
            });
            setActivePage('dashboard');
        };

        const openAssignModal = (account) => {
            setModalState({
                open: true,
                account,
                selected: account.strategies.slice()
            });
        };

        const closeAssignModal = () => {
            setModalState({
                open: false,
                account: null,
                selected: []
            });
        };

        const toggleModalStrategy = (strategyName) => {
            setModalState(prev => {
                const exists = prev.selected.includes(strategyName);
                const nextSelected = exists
                    ? prev.selected.filter(name => name !== strategyName)
                    : [...prev.selected, strategyName];
                return { ...prev, selected: nextSelected };
            });
        };

        const saveStrategyAssignment = () => {
            if (!modalState.account) return;
            const accountName = modalState.account.name;
            const selectedStrategies = modalState.selected;

            setAccounts(prev => prev.map(account => account.name === accountName
                ? { ...account, strategies: selectedStrategies }
                : account
            ));

            setStrategies(prev => prev.map(strategy => {
                const hasAccount = strategy.accounts.includes(accountName);
                if (selectedStrategies.includes(strategy.name) && !hasAccount) {
                    return { ...strategy, accounts: [...strategy.accounts, accountName] };
                }
                if (!selectedStrategies.includes(strategy.name) && hasAccount) {
                    return { ...strategy, accounts: strategy.accounts.filter(acc => acc !== accountName) };
                }
                return strategy;
            }));

            addLog({
                timestamp: nowString(),
                account: accountName,
                strategy: selectedStrategies.join(', ') || 'æ— ',
                type: 'é…ç½®',
                message: 'ğŸ”„ ç­–ç•¥å…³è”å·²æ›´æ–°',
                details: []
            });

            closeAssignModal();
        };

        return (
            <div className="flex h-full">
                <Sidebar activePage={activePage} onSelect={setActivePage} />
                <main className="flex-1 overflow-y-auto bg-white">
                    {activePage === 'dashboard' && (
                        <Dashboard
                            stats={stats}
                            strategies={strategies}
                            onNavigate={setActivePage}
                            onSimulate={simulateStrategyTrigger}
                        />
                    )}
                    {activePage === 'executions' && (
                        <ExecutionsPage executions={executions} />
                    )}
                    {activePage === 'accounts' && (
                        <AccountsPage accounts={accounts} onAssign={openAssignModal} />
                    )}
                    {activePage === 'settings' && <SettingsPage />}
                    {activePage === 'strategy-config' && (
                        <StrategyConfigPage
                            strategyForm={strategyForm}
                            onFormChange={handleFormChange}
                            selectedAccounts={strategyForm.selectedAccounts}
                            onToggleAccount={handleAccountToggle}
                            signals={signals}
                            onAddSignal={handleAddSignal}
                            onSignalIndicator={handleSignalIndicatorChange}
                            onSignalField={handleSignalFieldChange}
                            onRemoveSignal={handleRemoveSignal}
                            positionValues={positionValues}
                            onFormulaChange={handleFormulaChange}
                            onPositionFieldChange={handlePositionFieldChange}
                            onSave={handleSaveStrategy}
                        />
                    )}
                </main>
                <InfoPanel logs={logs} />
                <AssignStrategyModal
                    isOpen={modalState.open}
                    accountName={modalState.account?.name ?? ''}
                    strategies={strategies}
                    selected={modalState.selected}
                    onToggle={toggleModalStrategy}
                    onClose={closeAssignModal}
                    onSave={saveStrategyAssignment}
                />
            </div>
        );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
